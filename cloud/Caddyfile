{
  email {$ACME_EMAIL}
}

metrics.{$BASE_DOMAIN} {
  handle /api/v1/write* {
    request_body {
      max_size 50MB
    }
    basic_auth {
      {$VM_WRITE_USER} {$VM_WRITE_PASS_HASH}
    }
    reverse_proxy victoria-metrics:8428
  }

  handle /write* {
    request_body {
      max_size 50MB
    }
    basic_auth {
      {$VM_WRITE_USER} {$VM_WRITE_PASS_HASH}
    }
    reverse_proxy victoria-metrics:8428
  }

  respond 403
}

grafana.{$BASE_DOMAIN} {
  reverse_proxy grafana:3000
}

map.{$BASE_DOMAIN} {
  handle /api/* {
    reverse_proxy api:8089
  }

  # MQTT over WebSocket for realtime fleet data
  handle /mqtt {
    reverse_proxy mqtt:9001
  }

  handle {
    reverse_proxy map:8080
  }
}

# NOTE: mqtt.{$BASE_DOMAIN} can be added when DNS record is created
# For now, edge bridges connect via raw MQTT on port 1883
# Browser clients use wss://map.{$BASE_DOMAIN}/mqtt
