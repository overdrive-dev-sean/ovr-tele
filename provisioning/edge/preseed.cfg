# Debian 13 (trixie) unattended install for OVR N100 nodes.
# Place at the root of the installer USB as /cdrom/preseed.cfg.
# Boot parameter: auto=true priority=critical preseed/file=/cdrom/preseed.cfg

### Localization
d-i debian-installer/locale string en_US.UTF-8
d-i keyboard-configuration/xkb-keymap select us
d-i time/zone string America/Los_Angeles
d-i clock-setup/utc boolean true
d-i clock-setup/ntp boolean true

### Network (prompt for hostname; use priority=high/medium to see it)
d-i netcfg/choose_interface select auto
d-i netcfg/get_hostname seen false
d-i netcfg/get_domain string local

### Mirror (edit if using a local mirror)
d-i mirror/country string manual
d-i mirror/http/hostname string deb.debian.org
d-i mirror/http/directory string /debian
d-i mirror/http/proxy string
d-i mirror/suite string trixie

### Accounts
d-i passwd/root-login boolean false
d-i passwd/user-fullname string OVR Admin
d-i passwd/username string ovr
#d-i passwd/user-password password
#d-i passwd/user-password-again password
d-i user-setup/allow-password-weak boolean true
d-i passwd/user-default-groups string audio cdrom video sudo adm docker
# Prefer a hashed password for production:
d-i passwd/user-password-crypted password $6$Cb.O.NRxn06QbXgy$ePrN6NUgq28ErHyVJ5p1c4/Nvfg4A0prGNmV7kBm0e9zOpDhKY7G/4qs5WmLkIzyof5d6gbAsWKJYF/lxNGqQ1

### Partitioning (single 500GB NVMe, UEFI/GPT)
# Update the disk path if needed (e.g., /dev/sda for SATA).
d-i partman-auto/disk string /dev/nvme0n1
d-i partman-partitioning/default_label string gpt
d-i partman-auto/method string regular
d-i partman-auto/choose_recipe select ovr-500g-uefi
# Ensure a clean partition table by wiping primary and backup GPT headers.
d-i partman/early_command string /bin/sh -c "DISK=/dev/nvme0n1; dd if=/dev/zero of=$DISK bs=1M count=10; SECTORS=$(cat /sys/block/nvme0n1/size); dd if=/dev/zero of=$DISK bs=512 count=2048 seek=$((SECTORS-2048)); sync" || true
d-i partman-auto/expert_recipe string \
  ovr-500g-uefi :: \
    512 512 512 fat32 \
      $iflabel{ gpt } $primary{ } $bootable{ } \
      method{ efi } format{ } \
      use_filesystem{ } filesystem{ fat32 } \
    . \
    30720 30720 30720 ext4 \
      method{ format } format{ } \
      use_filesystem{ } filesystem{ ext4 } \
      mountpoint{ / } \
    . \
    40960 40960 40960 ext4 \
      method{ format } format{ } \
      use_filesystem{ } filesystem{ ext4 } \
      mountpoint{ /var } \
    . \
    8192 8192 8192 ext4 \
      method{ format } format{ } \
      use_filesystem{ } filesystem{ ext4 } \
      mountpoint{ /var/log } \
    . \
    1 1 -1 ext4 \
      method{ format } format{ } \
      use_filesystem{ } filesystem{ ext4 } \
      mountpoint{ /srv/data } \
    .
d-i partman/confirm_write_new_label boolean true
d-i partman/choose_partition select finish
d-i partman/confirm boolean true
d-i partman/confirm_nooverwrite boolean true
d-i partman-md/device_remove_md boolean true
d-i partman-md/confirm boolean true
d-i partman-md/confirm_nooverwrite boolean true
d-i partman-lvm/device_remove_lvm boolean true
d-i partman-lvm/confirm boolean true
d-i partman-lvm/confirm_nooverwrite boolean true
d-i partman/mount_style select uuid

### Packages (minimal; additional packages installed at first boot)
d-i pkgsel/run_tasksel boolean false
d-i pkgsel/install-recommends boolean false
d-i pkgsel/install-language-support boolean false
d-i pkgsel/include string openssh-server sudo ca-certificates
d-i pkgsel/upgrade select none
popularity-contest popularity-contest/participate boolean false

### Bootloader
d-i grub-installer/only_debian boolean true
d-i grub-installer/bootdev string /dev/nvme0n1

### Post-install (NetworkManager default + security updates + SSH key + optional repo/config copy)
d-i preseed/late_command string \
  if [ -x /target/usr/bin/nmcli ]; then \
    in-target systemctl enable NetworkManager; \
    in-target systemctl disable networking || true; \
    in-target sh -c "printf 'auto lo\niface lo inet loopback\n' > /etc/network/interfaces"; \
    in-target mkdir -p /etc/NetworkManager/conf.d; \
    in-target sh -c "printf '[ifupdown]\nmanaged=true\n' > /etc/NetworkManager/conf.d/10-managed.conf"; \
  fi; \
  in-target sh -c "printf 'APT::Periodic::Update-Package-Lists \"1\";\nAPT::Periodic::Unattended-Upgrade \"1\";\n' > /etc/apt/apt.conf.d/20auto-upgrades"; \
  in-target systemctl enable unattended-upgrades || true; \
  in-target systemctl enable fstrim.timer || true; \
  in-target mkdir -p /etc/systemd/journald.conf.d; \
  in-target sh -c "printf '[Journal]\nSystemMaxUse=200M\nRuntimeMaxUse=50M\nSystemMaxFileSize=50M\n' > /etc/systemd/journald.conf.d/limits.conf"; \
  if [ -f /cdrom/authorized_keys ]; then \
    mkdir -p /target/home/ovr/.ssh; \
    cp /cdrom/authorized_keys /target/home/ovr/.ssh/authorized_keys; \
    in-target chown -R ovr:ovr /home/ovr/.ssh; \
    in-target chmod 700 /home/ovr/.ssh; \
    in-target chmod 600 /home/ovr/.ssh/authorized_keys; \
  elif [ -f /cdrom/ssh_key.pub ]; then \
    mkdir -p /target/home/ovr/.ssh; \
    cp /cdrom/ssh_key.pub /target/home/ovr/.ssh/authorized_keys; \
    in-target chown -R ovr:ovr /home/ovr/.ssh; \
    in-target chmod 700 /home/ovr/.ssh; \
    in-target chmod 600 /home/ovr/.ssh/authorized_keys; \
  fi; \
  if [ -d /cdrom/ovr ]; then \
    OVR_SEED_DIR=/cdrom/ovr; \
  elif [ -d /cdrom/overdrive ]; then \
    OVR_SEED_DIR=/cdrom/overdrive; \
  else \
    OVR_SEED_DIR=""; \
  fi; \
  if [ -n "$OVR_SEED_DIR" ]; then \
    mkdir -p /target/etc/ovr; \
    cp -a "$OVR_SEED_DIR"/. /target/etc/ovr/; \
    if [ -d /target/etc/ovr/secrets ]; then \
      chmod 700 /target/etc/ovr/secrets; \
      chmod 600 /target/etc/ovr/secrets/* 2>/dev/null || true; \
    fi; \
    if [ -f /target/etc/ovr/site.env ]; then \
      chmod 600 /target/etc/ovr/site.env; \
    fi; \
  fi; \
  if [ -d /cdrom/OVR_Telemetry_Stack ]; then \
    mkdir -p /target/opt/stack; \
    cp -a /cdrom/OVR_Telemetry_Stack/. /target/opt/stack/; \
  elif [ -f /cdrom/OVR_Telemetry_Stack.tar.gz ]; then \
    mkdir -p /target/opt/stack; \
    tar -xzf /cdrom/OVR_Telemetry_Stack.tar.gz -C /target/opt/stack --strip-components=1; \
  fi; \
  in-target sh -c "if [ ! -e /opt/edge ]; then ln -s /opt/stack/edge /opt/edge; fi"

### Finish
d-i finish-install/reboot_in_progress note
